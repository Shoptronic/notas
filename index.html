<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tareas y Apuntes por Voz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .recording-active { animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .email-overlay { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables de entorno inyectadas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        // ----------------------------------------------------------------------
        // *** MODIFICACIÓN CLAVE: PEGUE SU CONFIGURACIÓN DE FIREBASE AQUÍ ***
        // ----------------------------------------------------------------------
        let firebaseConfig = null;
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            // 1. Usar la configuración inyectada por el entorno (si existe)
            try {
                firebaseConfig = JSON.parse(__firebase_config);
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                // Queda como null
            }
        } else {
            // 2. SOLUCIÓN MANUAL: Si la inyección falla, reemplace el 'null' de abajo
            //    con el objeto JSON de su configuración de Firebase, como:
            //    { apiKey: "AIzaSy...", authDomain: "...", projectId: "...", ... }
            
            // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            // *** REEMPLAZADO por tu objeto JSON de Firebase ***
            firebaseConfig = {
                apiKey: "AIzaSyBiv_p8uLwhye_eIYQr0efhYYguuaAHyrU",
                authDomain: "proyecto-notas-de-voz.firebaseapp.com",
                projectId: "proyecto-notas-de-voz",
                storageBucket: "proyecto-notas-de-voz.firebasestorage.app",
                messagingSenderId: "541384770877",
                appId: "1:541384770877:web:525287bf7ed19b943eb154",
                measurementId: "G-DL8KD46KLC"
            }; 
            // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
        }
        // ----------------------------------------------------------------------


        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isAuthReady = false;
        window.allNotes = []; 
        window.currentSearchTerm = ''; 

        // --- Utilidades ---
        window.showOverlay = (message) => {
            const overlay = document.getElementById('message-overlay');
            document.getElementById('overlay-message').textContent = message;
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 3000);
        };

        window.updateUserIdDisplay = () => {
            const userIdDisplay = document.getElementById('user-id-display');
            const userEmail = localStorage.getItem('userEmail');
            if (userEmail) {
                userIdDisplay.innerHTML = `Sesión: <span class="font-semibold text-blue-600">${userEmail}</span>`;
            } else if (window.userId) {
                userIdDisplay.innerHTML = `ID Usuario: <span class="font-semibold text-gray-500 text-sm truncate">${window.userId}</span>`;
            } else {
                userIdDisplay.textContent = 'Conectando...';
            }
        };

        window.getCollectionPath = () => {
            if (!window.userId || !window.db) {
                return null;
            }
            // Ruta de datos privada segura: /artifacts/{appId}/users/{userId}/voice_notes
            return collection(window.db, `artifacts/${appId}/users/${window.userId}/voice_notes`);
        };

        // --- Funciones de Persistencia (Firestore) ---

        window.setupRealtimeListener = () => {
            if (!window.db || !window.userId) return;

            const colRef = window.getCollectionPath();
            if (!colRef) return;

            const notesQuery = query(colRef);

            const unsubscribe = onSnapshot(notesQuery, (snapshot) => {
                const notes = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    notes.push({ id: doc.id, ...data });
                });
                window.allNotes = notes; 
                filterAndRenderNotes();
            }, (error) => {
                if (error.code === 'permission-denied') {
                    document.getElementById('notes-list').innerHTML = `
                        <div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center">
                            ERROR DE PERMISOS (Firestore): No se pudo cargar la lista de notas. Debes publicar las **Reglas de Seguridad** en tu consola de Firebase.
                        </div>
                    `;
                }
                console.error("Error al obtener notas en tiempo real:", error);
            });
            return unsubscribe;
        };

        window.saveNote = async () => {
            if (!window.db) {
                window.showOverlay("Error: La base de datos no está disponible. La nota no se guardará.");
                return;
            }
            if (!window.isAuthReady) {
                window.showOverlay("Error: Conexión no lista. Inténtalo de nuevo.");
                return;
            }
            
            const title = document.getElementById('title-input').value.trim();
            const content = document.getElementById('transcription-output').value.trim();
            const dueDateInput = document.getElementById('due-date-input').value;
            const noDueDateCheckbox = document.getElementById('no-due-date-checkbox').checked;

            if (title === '' && content === '') {
                window.showOverlay("Error: La nota no puede estar vacía.");
                return;
            }

            let dueDate = null;
            if (!noDueDateCheckbox && dueDateInput) {
                dueDate = Timestamp.fromDate(new Date(dueDateInput));
            }

            const newNote = {
                title: title,
                content: content,
                created: Timestamp.now(),
                due: dueDate, 
                completed: false
            };

            const colRef = window.getCollectionPath();
            if (!colRef) {
                window.showOverlay("Error crítico: No se pudo determinar la ruta de la colección.");
                return;
            }

            try {
                await addDoc(colRef, newNote);
                window.showOverlay("Nota guardada exitosamente.");
                // Limpiar inputs
                document.getElementById('title-input').value = '';
                document.getElementById('transcription-output').value = '';
                window.setupDueDateToggle(); 
                window.checkSaveButtonStatus();

            } catch (error) {
                console.error("Error detallado al guardar:", error);
                let errorMessage = "Ocurrió un error al intentar guardar la nota. Revisa la consola.";
                if (error.code === 'permission-denied') {
                    errorMessage = `ERROR DE PERMISOS (Firestore): Revisa tus **Reglas de Seguridad** para permitir la operación **'create'**`;
                }
                window.showOverlay(errorMessage);
            }
        };

        window.toggleNoteCompletion = async (id, currentStatus) => {
            if (!window.isAuthReady) return;
            const docRef = doc(window.getCollectionPath(), id);
            try {
                await updateDoc(docRef, { completed: !currentStatus });
            } catch (error) {
                console.error("Error al actualizar la nota:", error);
                window.showOverlay("Error al actualizar el estado de la nota.");
            }
        };

        window.deleteNote = async (id) => {
            if (!window.isAuthReady) return;
            // No usamos confirm()
            const confirmDelete = document.createElement('div');
            confirmDelete.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDelete.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                    <h3 class="text-lg font-bold mb-3">Confirmar Eliminación</h3>
                    <p class="mb-4">¿Estás seguro de que quieres eliminar esta nota?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button id="confirm-delete" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Eliminar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDelete);

            document.getElementById('cancel-delete').onclick = () => document.body.removeChild(confirmDelete);
            document.getElementById('confirm-delete').onclick = async () => {
                document.body.removeChild(confirmDelete);
                const docRef = doc(window.getCollectionPath(), id);
                try {
                    await deleteDoc(docRef);
                    window.showOverlay("Nota eliminada.");
                } catch (error) {
                    console.error("Error al eliminar la nota:", error);
                    window.showOverlay("Error al eliminar la nota.");
                }
            };
        };

        window.copyNoteContent = (note) => {
            const dueText = note.due ? `Vencimiento: ${note.due.toDate().toLocaleString('es-ES')}` : 'Sin Vencimiento';
            const status = note.completed ? ' (COMPLETADA)' : ' (PENDIENTE)';
            const content = `[${note.title || 'NOTA'}]${status}\n${note.content}\n${dueText}`;

            const el = document.createElement('textarea');
            el.value = content;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);

            window.showOverlay("Contenido copiado al portapapeles.");
        };


        // --- Funciones de Renderizado y Búsqueda ---

        window.filterAndRenderNotes = () => {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            window.currentSearchTerm = searchTerm;
            
            const sortedNotes = [...window.allNotes].sort((a, b) => {
                if (a.completed !== b.completed) {
                    return a.completed ? 1 : -1; 
                }
                return b.created.toDate() - a.created.toDate();
            });

            const filteredNotes = sortedNotes.filter(note => {
                if (searchTerm === '') return true;
                const title = note.title ? note.title.toLowerCase() : '';
                const content = note.content ? note.content.toLowerCase() : '';
                return title.includes(searchTerm) || content.includes(searchTerm);
            });

            renderNotes(filteredNotes);
        };

        window.renderNotes = (notes) => {
            const notesList = document.getElementById('notes-list');
            notesList.innerHTML = '';
            
            if (!window.db) {
                notesList.innerHTML = `<p class="text-center text-red-500 mt-8 font-bold">⚠️ Error: Configuración de BD no disponible. Las notas NO se guardarán.</p>`;
                return;
            }

            if (notes.length === 0 && window.currentSearchTerm === '') {
                notesList.innerHTML = `<p class="text-center text-gray-500 mt-8">Aún no tienes notas. ¡Presiona el micrófono para grabar una!</p>`;
                return;
            }
            if (notes.length === 0 && window.currentSearchTerm !== '') {
                 notesList.innerHTML = `<p class="text-center text-gray-500 mt-8">No se encontraron notas con el término "${window.currentSearchTerm}".</p>`;
                return;
            }

            notes.forEach(note => {
                const createdDate = note.created ? note.created.toDate().toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';
                
                let dueText = 'Sin Vencimiento';
                let dueColor = 'text-gray-500'; 

                if (note.due) {
                    const dueDate = note.due.toDate();
                    const now = new Date();
                    
                    const datePart = dueDate.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                    const timePart = dueDate.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    dueText = `${datePart} ${timePart}`;

                    if (note.completed) {
                        dueColor = 'text-green-600'; 
                    } else if (dueDate < now) {
                        dueColor = 'text-red-600 font-bold'; 
                    } else {
                        dueColor = 'text-yellow-600'; 
                    }
                } else if (note.completed) {
                     dueColor = 'text-green-600';
                }

                const completionClass = note.completed ? 'opacity-60 bg-white border-green-300' : 'bg-white shadow-lg border-gray-100';
                const completionIcon = note.completed ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'; 

                const noteElement = document.createElement('div');
                noteElement.className = `p-4 rounded-xl border transition-all duration-300 ${completionClass}`;
                noteElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1 min-w-0">
                            <h3 class="text-lg font-bold truncate ${note.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${note.title || 'Nota sin Título'}</h3>
                            <p class="text-sm text-gray-600 whitespace-pre-wrap mt-1 ${note.completed ? 'line-through' : ''}">${note.content}</p>
                        </div>
                        <div class="flex space-x-2 ml-4 flex-shrink-0">
                            <!-- Botón Copiar -->
                            <button onclick="window.copyNoteContent(${JSON.stringify(note).replace(/'/g, "\\'")})" 
                                class="p-2 rounded-full hover:bg-gray-100 text-gray-500 transition-colors" title="Copiar nota">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="10" y="9" width="12" height="15" rx="2" ry="2"></rect><path d="M4 15V4a2 2 0 0 1 2-2h9"></path></svg>
                            </button>

                            <!-- Botón Marcar/Desmarcar -->
                            <button onclick="window.toggleNoteCompletion('${note.id}', ${note.completed})" 
                                class="p-2 rounded-full transition-colors ${note.completed ? 'bg-green-100 text-green-600 hover:bg-green-200' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}" 
                                title="${note.completed ? 'Marcar como pendiente' : 'Marcar como hecha'}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${completionIcon}"></path></svg>
                            </button>

                            <!-- Botón Eliminar -->
                            <button onclick="window.deleteNote('${note.id}')" 
                                class="p-2 rounded-full hover:bg-red-100 text-red-500 transition-colors" title="Eliminar nota">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-3 text-xs flex justify-between">
                        <span class="text-gray-400">Creada: ${createdDate}</span>
                        <span class="${dueColor}">Vencimiento: ${dueText}</span>
                    </div>
                `;
                notesList.appendChild(noteElement);
            });
        };

        // --- Funciones de Interfaz de Usuario ---

        window.checkSaveButtonStatus = () => {
            const title = document.getElementById('title-input').value.trim();
            const content = document.getElementById('transcription-output').value.trim();
            const saveButton = document.getElementById('save-note-btn');

            if (!window.isAuthReady) {
                saveButton.disabled = true;
                saveButton.textContent = 'Conectando a la base de datos...';
                return;
            }
            
            if (!window.db) {
                saveButton.disabled = true;
                saveButton.textContent = 'Error: BD Inactiva';
                return;
            }

            if (title || content) {
                saveButton.disabled = false;
                saveButton.textContent = 'Guardar Nota';
            } else {
                saveButton.disabled = true;
                saveButton.textContent = 'Escribe o Graba para Guardar';
            }
        };

        window.setupDueDateToggle = () => {
            const checkbox = document.getElementById('no-due-date-checkbox');
            const input = document.getElementById('due-date-input');
            const label = document.getElementById('due-date-label');

            const toggleState = () => {
                input.disabled = checkbox.checked;
                input.classList.toggle('opacity-50', checkbox.checked);
                label.classList.toggle('text-gray-400', checkbox.checked);
                if (checkbox.checked) {
                    input.value = '';
                } else {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() + 1);
                    const formattedDate = now.toISOString().slice(0, 16);
                    input.value = formattedDate;
                }
            };
            
            checkbox.addEventListener('change', toggleState);
            toggleState();
        };

        // --- Inicialización y Autenticación de Firebase (Flujo Robusto) ---

        window.initFirebase = async () => {
            
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                console.error("FIREBASE ERROR: La configuración está ausente. La persistencia está deshabilitada.");
                window.isAuthReady = true;
                document.getElementById('user-id-display').innerHTML = '<span class="text-red-600 font-semibold">⚠️ Persistencia Deshabilitada</span>';
                window.renderNotes([]); 
                window.checkSaveButtonStatus();
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                
                window.db = getFirestore(app);
                window.auth = getAuth(app);
                // setLogLevel('debug'); // Descomentar para ver logs de Firebase

                let finalUserId = null;

                if (initialAuthToken) {
                    try {
                        const userCredential = await signInWithCustomToken(window.auth, initialAuthToken);
                        finalUserId = userCredential.user.uid;
                    } catch (error) {
                        console.warn("Fallo en signInWithCustomToken, intentando anónimo:", error);
                    }
                }

                if (!finalUserId) {
                    try {
                        const userCredential = await signInAnonymously(window.auth);
                        finalUserId = userCredential.user.uid;
                    } catch (error) {
                        console.error("Fallo crítico en signInAnonymously. Usando ID temporal.", error);
                        finalUserId = `temporal-${crypto.randomUUID()}`;
                    }
                }
                
                window.userId = finalUserId;
                window.isAuthReady = true;

                window.updateUserIdDisplay();
                window.checkSaveButtonStatus();
                window.setupRealtimeListener(); 

            } catch (e) {
                console.error("Error FATAL al inicializar Firebase:", e);
                document.getElementById('user-id-display').textContent = 'Error de conexión fatal';
                window.isAuthReady = true; 
                window.checkSaveButtonStatus();
            }
        };

        // --- API de Voz (Speech Recognition) ---

        window.toggleRecording = () => {
            const micBtn = document.getElementById('mic-btn');
            const output = document.getElementById('transcription-output');
            const isRecording = micBtn.classList.contains('recording-active');
            
            if (isRecording) {
                if (window.recognition) {
                    window.recognition.stop();
                }
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                window.showOverlay("Error: El reconocimiento de voz no es compatible con este navegador.");
                return;
            }

            const recognition = new SpeechRecognition();
            window.recognition = recognition;
            recognition.continuous = true;
            recognition.interimResults = true; 
            recognition.lang = 'es-ES';

            recognition.onstart = () => {
                micBtn.classList.add('recording-active');
                micBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path><path d="M19 10a7 7 0 0 1-7 7a7 7 0 0 1-7-7"></path><path d="M12 17v4m-5.46-3.79l-1.42 1.42M17.46 13.21l1.42 1.42"></path></svg>`;
                output.placeholder = 'Escuchando... Di tu nota...';
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                if (finalTranscript) {
                    output.value = finalTranscript.trim();
                } else if (interimTranscript) {
                     output.value = interimTranscript.trim();
                }
                window.checkSaveButtonStatus(); 
            };

            recognition.onend = () => {
                micBtn.classList.remove('recording-active');
                micBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="17" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>`;
                output.placeholder = 'Transcripción terminada.';
                
                setTimeout(() => {
                    window.checkSaveButtonStatus();
                }, 50); 
            };
            
            recognition.onerror = (event) => {
                console.error("Error de reconocimiento de voz:", event.error);
                micBtn.classList.remove('recording-active');
                window.showOverlay(`Error de grabación: ${event.error}`);
            };

            recognition.start();
        };

        // --- Setup de Email y Overlay ---

        window.setupEmailOverlay = () => {
            const email = localStorage.getItem('userEmail');
            const overlay = document.getElementById('email-overlay');

            if (email) {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
                document.getElementById('save-email-btn').addEventListener('click', () => {
                    const emailInput = document.getElementById('email-input').value.trim();
                    if (emailInput && emailInput.includes('@')) {
                        localStorage.setItem('userEmail', emailInput);
                        overlay.classList.add('hidden');
                        window.updateUserIdDisplay();
                    } else {
                        // Reemplazamos alert() por un modal simple
                        const errorModal = document.createElement('div');
                        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        errorModal.innerHTML = `
                            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                                <h3 class="text-lg font-bold mb-3 text-red-600">Error de Entrada</h3>
                                <p class="mb-4">Por favor, introduce un correo electrónico válido.</p>
                                <div class="flex justify-end">
                                    <button id="close-error-modal" class="px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">Aceptar</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(errorModal);
                        document.getElementById('close-error-modal').onclick = () => document.body.removeChild(errorModal);
                    }
                });
            }
        };

        // --- Inicialización Principal ---

        window.onload = () => {
            window.initFirebase();
            window.setupDueDateToggle();
            window.setupEmailOverlay();
            
            document.getElementById('title-input').addEventListener('input', window.checkSaveButtonStatus);
            document.getElementById('transcription-output').addEventListener('input', window.checkSaveButtonStatus);
            document.getElementById('search-input').addEventListener('input', window.filterAndRenderNotes);

            const now = new Date();
            now.setMinutes(now.getMinutes() + 1);
            document.getElementById('due-date-input').value = now.toISOString().slice(0, 16);
            
            window.checkSaveButtonStatus();
        };

    </script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- Overlay de Mensajes -->
    <div id="message-overlay" class="fixed inset-0 flex items-center justify-center bg-transparent z-50 hidden pointer-events-none">
        <div class="bg-gray-800 text-white py-2 px-4 rounded-lg shadow-2xl transition-opacity duration-300 opacity-90">
            <p id="overlay-message" class="text-sm font-medium"></p>
        </div>
    </div>

    <!-- Overlay de Solicitud de Email -->
    <div id="email-overlay" class="fixed inset-0 flex items-center justify-center z-40 email-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
            <h2 class="text-xl font-bold mb-4">Identificador de Sesión</h2>
            <p class="text-sm text-gray-600 mb-4">Para identificar tus notas, por favor ingresa tu correo electrónico. Solo se guardará localmente en tu navegador.</p>
            <input id="email-input" type="email" placeholder="tu.correo@ejemplo.com" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 mb-4">
            <button id="save-email-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors">Guardar y Continuar</button>
        </div>
    </div>

    <!-- Contenedor Principal -->
    <div class="max-w-4xl mx-auto p-4 sm:p-6">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-900">Apuntes por Voz <span class="text-sm font-normal text-gray-500">v1.0</span></h1>
            <p id="user-id-display" class="mt-2 sm:mt-0 text-sm text-gray-600">Conectando a la base de datos y cargando notas...</p>
        </header>

        <!-- Sección de Entrada de Nota -->
        <section class="mt-6 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4">Nueva Nota/Tarea por Voz</h2>

            <!-- Input de Título -->
            <input type="text" id="title-input" placeholder="Título de la Nota (Ej: Recordatorio excursión)" 
                class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500 transition-shadow" />

            <!-- Área de Transcripción -->
            <textarea id="transcription-output" rows="3" placeholder="Presiona el micrófono para empezar a grabar tu nota..." 
                class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-blue-500 focus:border-blue-500 transition-shadow" disabled></textarea>

            <!-- Controles de Grabación y Vencimiento -->
            <div class="flex flex-col sm:flex-row justify-between items-center sm:items-end mt-4">
                
                <!-- Columna 1: Micrófono y Guardado -->
                <div class="flex space-x-4 mb-4 sm:mb-0 items-center">
                    <button id="mic-btn" onclick="window.toggleRecording()" 
                        class="w-16 h-16 bg-red-500 text-white rounded-full flex items-center justify-center shadow-xl hover:bg-red-600 transition-all duration-300 active:scale-95" 
                        title="Toca para grabar, toca de nuevo para parar.">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path><path d="M19 10a7 7 0 0 1-7 7a7 7 0 0 1-7-7"></path><path d="M12 17v4m-5.46-3.79l-1.42 1.42M17.46 13.21l1.42 1.42"></path></svg>
                    </button>
                    
                    <button id="save-note-btn" onclick="window.saveNote()" disabled
                        class="px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold shadow-md hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        Guardar Nota
                    </button>
                </div>

                <!-- Columna 2: Vencimiento -->
                <div class="flex flex-col items-end">
                    <label id="due-date-label" for="due-date-input" class="text-sm font-medium mb-1">Fecha y Hora de Vencimiento:</label>
                    <input type="datetime-local" id="due-date-input" 
                        class="p-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 transition-shadow w-full sm:w-auto mb-2" />

                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="no-due-date-checkbox" class="form-checkbox h-4 w-4 text-gray-600 rounded">
                        <label for="no-due-date-checkbox" class="text-sm text-gray-600">No tiene vencimiento</label>
                    </div>
                </div>
            </div>
        </section>

        <!-- Sección de Búsqueda y Lista de Notas -->
        <section class="mt-8">
            <h2 class="text-2xl font-semibold mb-4">Tus Notas y Tareas</h2>

            <!-- Barra de Búsqueda -->
            <div class="mb-6">
                <input type="text" id="search-input" placeholder="Buscar por título o contenido..." 
                    class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500 transition-shadow" />
            </div>

            <!-- Lista de Notas (Contenedor de Renderizado) -->
            <div id="notes-list" class="space-y-4">
                <p class="text-center text-gray-500 mt-8">Conectando a la base de datos y cargando notas...</p>
            </div>
        </section>
    </div>

</body>
</html>
